<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Gerar Token - Cart√£o Salvo</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body { background: #fff; }
        #hidden-fields {
          position: absolute;
          top: -9999px;
          left: -9999px;
          width: 0;
          height: 0;
          overflow: hidden;
        }
    </style>
</head>
<body>
<div id="hidden-fields">
    <div id="cardNumber"></div>
    <div id="securityCode"></div>
</div>

<script>
    const mp = new MercadoPago('APP_USR-21e84916-3118-4cc9-bf93-c4b20fea905f', { locale: 'pt-BR' });

    // Cria os campos ‚Äúfakes‚Äù invis√≠veis pra satisfazer o SDK
    const cardNumberField = mp.fields.create('cardNumber', { placeholder: '' });
    cardNumberField.mount('cardNumber');

    const securityCodeField = mp.fields.create('securityCode', { placeholder: '' });
    securityCodeField.mount('securityCode');

    async function generateToken(cardId, cvv) {
      try {
        if (!cardId || !cvv) {
          Android.onToken(JSON.stringify({ ok: false, error: 'Par√¢metros inv√°lidos.' }));
          return;
        }

        console.log('ü™Ñ Gerando token para cart√£o salvo:', cardId);

        // Aguarda um pouquinho pra garantir que os fields foram montados
        await new Promise((r) => setTimeout(r, 500));

        // Gera o token para o cart√£o salvo
        const token = await mp.fields.createCardToken({
          cardId: cardId,
          securityCode: cvv
        });

        console.log('‚úÖ Token gerado com sucesso:', token.id);
        Android.onToken(JSON.stringify({ ok: true, token: token.id }));
      } catch (error) {
        console.error('‚ùå Erro ao gerar token:', error);
        const message = Array.isArray(error)
          ? error.map(e => `${e.field}: ${e.message}`).join(' | ')
          : (error.message || 'Erro desconhecido');
        Android.onToken(JSON.stringify({ ok: false, error: message }));
      }
    }

    // Exp√µe pro Kotlin
    window.generateToken = generateToken;
</script>
</body>
</html>
